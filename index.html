<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fanqie Novel Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0d0f12;
    --surface: #151820;
    --surface2: #1c2130;
    --border: #252d3d;
    --border2: #2e3a50;
    --accent: #4f9eff;
    --accent2: #7c5cfc;
    --green: #2dce7a;
    --yellow: #f5c542;
    --red: #ff5a5a;
    --orange: #ff8c42;
    --text: #cdd6f4;
    --text2: #8899bb;
    --text3: #556080;
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'IBM Plex Sans', sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); font-size: 13px; min-height: 100vh; }
  
  /* HEADER */
  header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 16px; display: flex; align-items: center; gap: 16px; height: 44px; position: sticky; top: 0; z-index: 100; }
  header .logo { font-family: var(--mono); font-weight: 600; font-size: 14px; color: var(--accent); letter-spacing: -0.5px; }
  header .logo span { color: var(--text3); }
  .tab-bar { display: flex; gap: 2px; }
  .tab { padding: 5px 14px; border-radius: 4px; cursor: pointer; color: var(--text2); font-size: 12px; font-weight: 500; transition: all 0.15s; border: 1px solid transparent; }
  .tab:hover { color: var(--text); background: var(--surface2); }
  .tab.active { color: var(--accent); background: rgba(79,158,255,0.1); border-color: rgba(79,158,255,0.2); }
  .header-right { margin-left: auto; display: flex; align-items: center; gap: 8px; }
  .sync-info { font-family: var(--mono); font-size: 10px; color: var(--text3); }
  .btn { display: inline-flex; align-items: center; gap: 5px; padding: 5px 11px; border-radius: 4px; border: 1px solid var(--border2); background: var(--surface2); color: var(--text); cursor: pointer; font-size: 12px; font-family: var(--sans); font-weight: 500; transition: all 0.15s; white-space: nowrap; }
  .btn:hover { border-color: var(--accent); color: var(--accent); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }
  .btn.primary:hover { background: #6bb3ff; border-color: #6bb3ff; color: #000; }
  .btn.danger { border-color: var(--red); color: var(--red); }
  .btn.danger:hover { background: rgba(255,90,90,0.1); }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }

  /* MAIN */
  main { padding: 12px 16px; }
  .section { display: none; }
  .section.active { display: block; }

  /* TOOLBAR */
  .toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
  .toolbar-left { display: flex; align-items: center; gap: 8px; flex: 1; flex-wrap: wrap; }
  .toolbar-right { display: flex; align-items: center; gap: 6px; }
  .select-count { font-family: var(--mono); font-size: 11px; color: var(--text2); padding: 4px 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 4px; }
  select, input[type="text"], input[type="number"] {
    background: var(--surface); border: 1px solid var(--border2); color: var(--text);
    padding: 5px 9px; border-radius: 4px; font-family: var(--sans); font-size: 12px;
    outline: none; transition: border-color 0.15s;
  }
  select:focus, input:focus { border-color: var(--accent); }
  select { cursor: pointer; }

  /* ADD PANEL */
  .add-panel { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 12px; margin-bottom: 10px; display: none; }
  .add-panel.open { display: block; }
  .add-panel h4 { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; font-family: var(--mono); }
  .add-panel textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 8px; border-radius: 4px; font-family: var(--mono); font-size: 11px; resize: vertical; min-height: 80px; outline: none; }
  .add-panel textarea:focus { border-color: var(--accent); }
  .add-panel .hint { font-size: 10px; color: var(--text3); margin-top: 4px; font-family: var(--mono); }
  .add-panel .actions { display: flex; gap: 6px; margin-top: 8px; }

  /* TABLE */
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th { background: var(--surface); padding: 7px 10px; text-align: left; font-size: 10px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; user-select: none; }
  thead th:hover { color: var(--text2); }
  thead th .sort-icon { margin-left: 3px; opacity: 0.4; }
  thead th.sorted .sort-icon { opacity: 1; color: var(--accent); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.1s; }
  tbody tr:hover { background: var(--surface); }
  tbody tr.selected { background: rgba(79,158,255,0.05); }
  tbody tr.selected:hover { background: rgba(79,158,255,0.08); }
  td { padding: 7px 10px; vertical-align: middle; }
  td.check-col { width: 32px; }
  input[type="checkbox"] { accent-color: var(--accent); width: 13px; height: 13px; cursor: pointer; }
  .title-cell { max-width: 220px; }
  .title-main { font-weight: 500; color: var(--text); font-size: 12px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .title-id { font-family: var(--mono); font-size: 10px; color: var(--text3); }
  .mono { font-family: var(--mono); font-size: 11px; }
  .link { color: var(--accent); text-decoration: none; }
  .link:hover { text-decoration: underline; }

  /* TAGS */
  .tag { display: inline-flex; align-items: center; padding: 2px 7px; border-radius: 3px; font-size: 10px; font-weight: 600; font-family: var(--mono); white-space: nowrap; }
  .tag-green { background: rgba(45,206,122,0.12); color: var(--green); border: 1px solid rgba(45,206,122,0.25); }
  .tag-yellow { background: rgba(245,197,66,0.12); color: var(--yellow); border: 1px solid rgba(245,197,66,0.25); }
  .tag-red { background: rgba(255,90,90,0.12); color: var(--red); border: 1px solid rgba(255,90,90,0.25); }
  .tag-blue { background: rgba(79,158,255,0.12); color: var(--accent); border: 1px solid rgba(79,158,255,0.25); }
  .tag-orange { background: rgba(255,140,66,0.12); color: var(--orange); border: 1px solid rgba(255,140,66,0.25); }
  .tag-purple { background: rgba(124,92,252,0.12); color: var(--accent2); border: 1px solid rgba(124,92,252,0.25); }

  /* WARNING TAGS (for changed tab) */
  .warn-tags { display: flex; gap: 3px; flex-wrap: wrap; }

  /* PROGRESS BAR */
  .progress-wrap { display: flex; align-items: center; gap: 6px; }
  .progress-bar { width: 60px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
  .progress-fill.warn { background: var(--orange); }
  .progress-fill.danger { background: var(--red); }

  /* AHEAD BADGE */
  .ahead { font-family: var(--mono); font-size: 11px; font-weight: 600; }
  .ahead.ok { color: var(--green); }
  .ahead.warn { color: var(--yellow); }
  .ahead.danger { color: var(--red); }

  /* UPDATE PANEL (sticky) */
  #update-panel {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: var(--surface); border-top: 1px solid var(--border2);
    padding: 10px 16px; display: none; z-index: 200;
    box-shadow: 0 -4px 24px rgba(0,0,0,0.4);
  }
  #update-panel.open { display: block; }
  #update-panel .inner { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  #update-panel label { font-size: 12px; color: var(--text2); font-weight: 500; white-space: nowrap; }
  #update-panel input[type="number"] { width: 80px; }
  #update-panel .hint { font-size: 10px; color: var(--text3); font-family: var(--mono); }

  /* MOVE PANEL */
  #move-panel { position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border2); padding: 10px 16px; display: none; z-index: 200; box-shadow: 0 -4px 24px rgba(0,0,0,0.4); }
  #move-panel.open { display: block; }
  #move-panel .inner { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
  #move-panel label { font-size: 12px; color: var(--text2); font-weight: 500; }
  #move-panel textarea { width: 300px; min-height: 60px; font-family: var(--mono); font-size: 11px; }
  #move-panel .hint { font-size: 10px; color: var(--text3); font-family: var(--mono); }

  /* EMPTY STATE */
  .empty { text-align: center; padding: 40px 20px; color: var(--text3); font-size: 12px; }
  .empty .icon { font-size: 28px; margin-bottom: 8px; }

  /* MODAL */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 300; display: none; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; padding: 20px; min-width: 340px; max-width: 500px; }
  .modal h3 { font-size: 14px; margin-bottom: 12px; }
  .modal p { color: var(--text2); font-size: 12px; margin-bottom: 16px; }
  .modal .actions { display: flex; gap: 8px; justify-content: flex-end; }

  /* FILTER PILLS */
  .filter-pills { display: flex; gap: 4px; }
  .pill { padding: 3px 10px; border-radius: 20px; border: 1px solid var(--border2); font-size: 11px; color: var(--text2); cursor: pointer; font-weight: 500; transition: all 0.15s; }
  .pill:hover { border-color: var(--accent); color: var(--accent); }
  .pill.active { background: rgba(79,158,255,0.1); border-color: var(--accent); color: var(--accent); }

  /* LOADING SPINNER */
  .spinner { width: 14px; height: 14px; border: 2px solid var(--border2); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* TOAST */
  #toast { position: fixed; bottom: 70px; right: 16px; background: var(--surface2); border: 1px solid var(--border2); border-radius: 6px; padding: 10px 14px; font-size: 12px; z-index: 400; display: none; box-shadow: 0 4px 16px rgba(0,0,0,0.4); max-width: 300px; }
  #toast.show { display: block; animation: fadeIn 0.2s; }
  #toast.success { border-color: var(--green); }
  #toast.error { border-color: var(--red); }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* ALERT BANNER */
  .alert-banner { background: rgba(245,197,66,0.08); border: 1px solid rgba(245,197,66,0.25); border-radius: 5px; padding: 8px 12px; margin-bottom: 10px; font-size: 11px; color: var(--yellow); display: flex; align-items: center; gap: 6px; }

  /* GITHUB TOKEN SETUP */
  #token-setup { background: var(--surface); border: 1px solid var(--border2); border-radius: 6px; padding: 16px; margin-bottom: 12px; }
  #token-setup h4 { font-size: 12px; margin-bottom: 8px; color: var(--text2); }
  #token-setup .row { display: flex; gap: 8px; align-items: center; }
  #token-setup input { flex: 1; font-family: var(--mono); font-size: 11px; }
  #token-setup .note { font-size: 10px; color: var(--text3); margin-top: 6px; font-family: var(--mono); }

  .config-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
  .config-row label { font-size: 11px; color: var(--text2); white-space: nowrap; min-width: 80px; }
  .config-row input { flex: 1; min-width: 160px; font-family: var(--mono); font-size: 11px; }

  hr { border: none; border-top: 1px solid var(--border); margin: 10px 0; }
</style>
</head>
<body>

<header>
  <div class="logo">fanqie<span>/</span>tracker</div>
  <div class="tab-bar">
    <div class="tab active" onclick="switchTab('waiting')">‚è≥ Waiting <span id="waiting-count-badge" class="tag tag-blue" style="margin-left:4px;font-size:9px;"></span></div>
    <div class="tab" onclick="switchTab('uploading')">‚úçÔ∏è Uploading <span id="trans-count-badge" class="tag tag-green" style="margin-left:4px;font-size:9px;"></span></div>
    <div class="tab" onclick="switchTab('changed')">‚ö†Ô∏è Changed <span id="changed-count-badge" class="tag tag-red" style="margin-left:4px;font-size:9px;"></span></div>
    <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
  </div>
  <div class="header-right">
    <span class="sync-info" id="sync-info">‚Äî</span>
    <button class="btn" id="scrape-btn" onclick="triggerScraper()" title="Trigger the Daily Scraper workflow on GitHub Actions">‚ñ∂ Run Scraper</button>
    <button class="btn" onclick="loadData()"><span id="refresh-icon">‚Üª</span> Refresh</button>
  </div>
</header>

<main>

<!-- ==================== SETTINGS ==================== -->
<div class="section" id="section-settings">
  <div id="token-setup">
    <h4>GitHub Configuration</h4>
    <div class="config-row">
      <label>Repo</label>
      <input id="cfg-repo" type="text" placeholder="username/repo-name" />
    </div>
    <div class="config-row">
      <label>PAT Token</label>
      <input id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx (needs issues write + contents write)" />
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn primary" onclick="saveConfig()">Save Config</button>
      <button class="btn" onclick="testConfig()">Test Connection</button>
    </div>
    <div class="note">Token is stored in sessionStorage only (not persisted). Re-enter on each visit for security.<br>Required scopes: repo (or contents + issues)</div>
  </div>
</div>

<!-- ==================== WAITING LIST ==================== -->
<div class="section active" id="section-waiting">
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn" onclick="toggleAddPanel('waiting')">+ Add Books</button>
      <button class="btn" onclick="selectAllVisible('waiting')">Select All</button>
      <span class="select-count" id="waiting-sel-count" style="display:none"></span>
      <button class="btn danger" id="waiting-del-btn" onclick="bulkDelete('waiting')" style="display:none">üóë Delete</button>
      <button class="btn" id="waiting-promote-btn" onclick="openMovePanel()" style="display:none">‚Üí Move to Uploading</button>
    </div>
    <div class="toolbar-right">
      <select id="waiting-sort" onchange="renderWaiting()">
        <option value="default">Sort: Default</option>
        <option value="chapters_asc">Chapters ‚Üë</option>
        <option value="chapters_desc">Chapters ‚Üì</option>
        <option value="updated_asc">Updated ‚Üë (Oldest)</option>
        <option value="updated_desc">Updated ‚Üì (Newest)</option>
        <option value="ready">Ready First</option>
      </select>
    </div>
  </div>
  <div class="add-panel" id="add-panel-waiting">
    <h4>Add to Waiting List ‚Äî Bulk</h4>
    <textarea id="waiting-input" placeholder="T√™n ti·∫øng Vi·ªát | s·ªë ch∆∞∆°ng mong mu·ªën | fanqieID&#10;V√≠ d·ª•:&#10;Xuy√™n th√†nh n√¥ng gia | 300 | 7506507753850948633&#10;ƒê·∫°o s∆∞ h·ªá th·ªëng | 200 | 7123456789012345678"></textarea>
    <div class="hint">Format: Vietnamese Title | Desired Chapters | Fanqie Book ID (one per line)</div>
    <div class="actions">
      <button class="btn primary" onclick="submitAdd('waiting')">Add Books</button>
      <button class="btn" onclick="toggleAddPanel('waiting')">Cancel</button>
    </div>
  </div>
  <div id="waiting-ready-banner" class="alert-banner" style="display:none">
    ‚ö†Ô∏è Some books have reached their desired chapter count ‚Äî select and move them to Uploading.
  </div>
  <div class="table-wrap">
    <table id="waiting-table">
      <thead>
        <tr>
          <th class="check-col"><input type="checkbox" id="waiting-check-all" onchange="toggleCheckAll('waiting', this.checked)"></th>
          <th onclick="setSortWaiting('title')">Title <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortWaiting('current_chapters')">Chapters <span class="sort-icon">‚Üï</span></th>
          <th>Desired</th>
          <th onclick="setSortWaiting('status')">Status <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortWaiting('last_updated')">Last Update <span class="sort-icon">‚Üï</span></th>
          <th>Ready?</th>
        </tr>
      </thead>
      <tbody id="waiting-tbody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== UPLOADING LIST ==================== -->
<div class="section" id="section-uploading">
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn" onclick="toggleAddPanel('uploading')">+ Add Books</button>
      <button class="btn" onclick="selectAllVisible('uploading')">Select All</button>
      <span class="select-count" id="trans-sel-count" style="display:none"></span>
      <button class="btn" id="trans-update-btn" onclick="openUpdatePanel()" style="display:none">‚úèÔ∏è Update Chapters</button>
      <button class="btn danger" id="trans-del-btn" onclick="bulkDelete('uploading')" style="display:none">üóë Delete</button>
    </div>
    <div class="toolbar-right">
      <select id="trans-sort" onchange="renderUploading()">
        <option value="default">Sort: Default</option>
        <option value="ahead_desc">Most Unuploaded</option>
        <option value="ahead_asc">Least Unuploaded</option>
        <option value="updated_desc">Newest Update</option>
        <option value="updated_asc">Oldest Update</option>
      </select>
    </div>
  </div>
  <div class="add-panel" id="add-panel-uploading">
    <h4>Add Directly to Uploading List ‚Äî Bulk</h4>
    <textarea id="uploading-input" placeholder="wikiID | uploaded chapters | fanqieID&#10;V√≠ d·ª•:&#10;aTwMd0bIjhne~Hxh | 45 | 7506507753850948633&#10;bXy123 | 10 | 7123456789012345678"></textarea>
    <div class="hint">Format: Wiki Book ID | Uploaded Chapters | Fanqie Book ID (one per line)</div>
    <div class="actions">
      <button class="btn primary" onclick="submitAdd('uploading')">Add Books</button>
      <button class="btn" onclick="toggleAddPanel('uploading')">Cancel</button>
    </div>
  </div>
  <div class="table-wrap">
    <table id="uploading-table">
      <thead>
        <tr>
          <th class="check-col"><input type="checkbox" id="trans-check-all" onchange="toggleCheckAll('uploading', this.checked)"></th>
          <th onclick="setSortTrans('vi_title')">Vietnamese Title <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortTrans('fanqie_chapters')">Fanqie Ch. <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortTrans('uploaded_chapters')">Uploaded <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortTrans('ahead')">Ahead <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortTrans('status')">Status <span class="sort-icon">‚Üï</span></th>
          <th onclick="setSortTrans('last_updated')">Last Update <span class="sort-icon">‚Üï</span></th>
          <th>Links</th>
        </tr>
      </thead>
      <tbody id="uploading-tbody"></tbody>
    </table>
  </div>
</div>

<!-- ==================== CHANGED ==================== -->
<div class="section" id="section-changed">
  <div class="toolbar">
    <div class="toolbar-left">
      <button class="btn" onclick="selectAllVisible('changed')">Select All</button>
      <span class="select-count" id="changed-sel-count" style="display:none"></span>
      <button class="btn danger" id="changed-del-btn" onclick="bulkDelete('changed')" style="display:none">üóë Delete</button>
      <div class="filter-pills" id="changed-filters">
        <div class="pill active" data-filter="all" onclick="setChangedFilter('all')">All</div>
        <div class="pill" data-filter="completed" onclick="setChangedFilter('completed')">‚úÖ Ho√†n th√†nh</div>
        <div class="pill" data-filter="stale" onclick="setChangedFilter('stale')">üïê Stale 15d+</div>
        <div class="pill" data-filter="behind" onclick="setChangedFilter('behind')">üìö 10+ Unuploaded</div>
      </div>
    </div>
  </div>
  <div class="table-wrap">
    <table id="changed-table">
      <thead>
        <tr>
          <th class="check-col"><input type="checkbox" id="changed-check-all" onchange="toggleCheckAll('changed', this.checked)"></th>
          <th>Vietnamese Title</th>
          <th>Fanqie Ch.</th>
          <th>Uploaded</th>
          <th>Ahead</th>
          <th>Status</th>
          <th>Last Update</th>
          <th>Warnings</th>
        </tr>
      </thead>
      <tbody id="changed-tbody"></tbody>
    </table>
  </div>
</div>

</main>

<!-- UPDATE PANEL (sticky bottom) -->
<div id="update-panel">
  <div class="inner">
    <label>Update chapters ‚Äî one <span class="mono" style="color:var(--accent)">fanqieID | new_chapter</span> per line:</label>
    <textarea id="update-chapter-input" placeholder="7506507753850948633 | 102&#10;7123456789012345678 | 26" style="width:320px;min-height:70px;font-family:var(--mono);font-size:11px;background:var(--bg);border:1px solid var(--border2);color:var(--text);padding:6px 8px;border-radius:4px;outline:none;resize:vertical;"></textarea>
    <div>
      <button class="btn primary" onclick="submitUpdateChapters()">Apply</button>
      <button class="btn" onclick="closeUpdatePanel()">Close</button>
    </div>
  </div>
</div>

<!-- MOVE PANEL (sticky bottom) -->
<div id="move-panel">
  <div class="inner">
    <label>Moving <strong id="move-count">0</strong> book(s) ‚Üí Uploading. Add Wiki IDs (optional):</label>
    <div>
      <textarea id="move-wiki-input" placeholder="wikiID (one per line, same order as selected)&#10;Leave blank lines to skip"></textarea>
      <div class="hint" id="move-books-hint"></div>
    </div>
    <button class="btn primary" onclick="submitMove()">Confirm Move</button>
    <button class="btn" onclick="closeMovePanel()">Cancel</button>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-overlay" id="confirm-modal">
  <div class="modal">
    <h3 id="modal-title">Confirm Action</h3>
    <p id="modal-body"></p>
    <div class="actions">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn danger" id="modal-confirm-btn">Confirm</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
let CFG = { repo: '', token: '' };
let waitingList = [];
let uploadingList = [];
let selectedWaiting = new Set();
let selectedUploading = new Set();
let selectedChanged = new Set();
let changedFilter = 'all';
let sortWaiting = 'default';
let sortTrans = 'default';
let lastSync = null;

function saveConfig() {
  CFG.repo = document.getElementById('cfg-repo').value.trim();
  CFG.token = document.getElementById('cfg-token').value.trim();
  if (!CFG.repo || !CFG.token) { toast('Please fill repo and token.', 'error'); return; }
  sessionStorage.setItem('fq_repo', CFG.repo);
  // Don't persist token in localStorage for security, only session
  sessionStorage.setItem('fq_token', CFG.token);
  toast('Config saved!', 'success');
  loadData();
}

function loadConfig() {
  CFG.repo = sessionStorage.getItem('fq_repo') || '';
  CFG.token = sessionStorage.getItem('fq_token') || '';
  if (CFG.repo) document.getElementById('cfg-repo').value = CFG.repo;
  if (CFG.token) document.getElementById('cfg-token').value = CFG.token;
}

async function testConfig() {
  if (!CFG.repo || !CFG.token) { toast('Save config first.', 'error'); return; }
  try {
    const r = await ghApi(`/repos/${CFG.repo}`);
    toast(`Connected: ${r.full_name}`, 'success');
  } catch(e) { toast('Connection failed: ' + e.message, 'error'); }
}

// ============================================================
// GITHUB API
// ============================================================
async function ghApi(path, options = {}) {
  const res = await fetch(`https://api.github.com${path}`, {
    ...options,
    headers: {
      'Authorization': `Bearer ${CFG.token}`,
      'Accept': 'application/vnd.github.v3+json',
      'Content-Type': 'application/json',
      ...(options.headers || {})
    }
  });
  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.message || res.statusText);
  }
  return res.json();
}

function b64ToUtf8(b64) {
  const binary = atob(b64.replace(/\n/g, ''));
  const bytes = Uint8Array.from(binary, c => c.charCodeAt(0));
  return new TextDecoder('utf-8').decode(bytes);
}

function utf8ToB64(str) {
  const bytes = new TextEncoder().encode(str);
  let binary = '';
  bytes.forEach(b => binary += String.fromCharCode(b));
  return btoa(binary);
}

async function getFile(filename) {
  try {
    const data = await ghApi(`/repos/${CFG.repo}/contents/${filename}`);
    const content = b64ToUtf8(data.content);
    return { data: JSON.parse(content), sha: data.sha };
  } catch(e) {
    if (e.message.includes('404') || e.message.includes('Not Found')) return { data: [], sha: null };
    throw e;
  }
}

async function putFile(filename, content, sha) {
  const body = {
    message: `Update ${filename} via web UI`,
    content: utf8ToB64(JSON.stringify(content, null, 2)),
  };
  if (sha) body.sha = sha;
  return ghApi(`/repos/${CFG.repo}/contents/${filename}`, {
    method: 'PUT',
    body: JSON.stringify(body)
  });
}

// ============================================================
// LOAD DATA
// ============================================================
async function loadData() {
  if (!CFG.repo || !CFG.token) {
    switchTab('settings');
    toast('Please configure GitHub first.', 'error');
    return;
  }
  document.getElementById('refresh-icon').className = 'spinner';
  try {
    const [w, t] = await Promise.all([
      getFile('waiting_list.json'),
      getFile('uploading_list.json')
    ]);
    waitingList = w.data;
    uploadingList = t.data;
    lastSync = new Date();
    document.getElementById('sync-info').textContent = 'synced ' + lastSync.toLocaleTimeString();
    renderAll();
    toast('Data loaded.', 'success');
  } catch(e) {
    toast('Load failed: ' + e.message, 'error');
  } finally {
    document.getElementById('refresh-icon').className = '';
    document.getElementById('refresh-icon').textContent = '‚Üª';
  }
}

async function saveWaiting() {
  const { sha } = await getFile('waiting_list.json');
  await putFile('waiting_list.json', waitingList, sha);
}

async function saveUploading() {
  const { sha } = await getFile('uploading_list.json');
  await putFile('uploading_list.json', uploadingList, sha);
}

// ============================================================
// TRIGGER SCRAPER
// ============================================================
async function triggerScraper() {
  if (!CFG.repo || !CFG.token) { toast('Configure GitHub first.', 'error'); return; }
  const btn = document.getElementById('scrape-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Triggering‚Ä¶';
  try {
    await ghApi(`/repos/${CFG.repo}/actions/workflows/scrape.yml/dispatches`, {
      method: 'POST',
      body: JSON.stringify({ ref: 'main' })
    });
    toast('Scraper triggered! Auto-refreshing data in ~75s.', 'success');
    btn.innerHTML = '‚è≥ Running‚Ä¶';
    // Auto-reload data after 75s (scraper usually finishes by then)
    setTimeout(async () => {
      await loadData();
      btn.disabled = false;
      btn.innerHTML = '‚ñ∂ Run Scraper';
    }, 75000);
  } catch(e) {
    toast('Failed to trigger: ' + e.message, 'error');
    btn.disabled = false;
    btn.innerHTML = '‚ñ∂ Run Scraper';
  }
}

// ============================================================
// TABS
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['waiting','uploading','changed','settings'][i] === tab);
  });
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('section-' + tab).classList.add('active');
}

// ============================================================
// RENDER HELPERS
// ============================================================
function fmtStatus(status) {
  if (!status) return '<span class="tag tag-blue">‚Äî</span>';
  if (status.includes('ËøûËΩΩ‰∏≠') || status.includes('c√≤n ti·∫øp')) return '<span class="tag tag-green">C√≤n ti·∫øp</span>';
  if (status.includes('Â∑≤ÂÆåÁªì') || status.includes('ho√†n th√†nh')) return '<span class="tag tag-orange">Ho√†n th√†nh</span>';
  return `<span class="tag tag-blue">${status}</span>`;
}

function daysSince(dateStr) {
  if (!dateStr) return 9999;
  const d = new Date(dateStr);
  return Math.floor((Date.now() - d.getTime()) / 86400000);
}

function fmtDate(dateStr) {
  if (!dateStr) return '<span style="color:var(--text3)">‚Äî</span>';
  const d = daysSince(dateStr);
  let cls = d >= 15 ? 'color:var(--red)' : d >= 7 ? 'color:var(--yellow)' : 'color:var(--text2)';
  return `<span style="${cls}" class="mono">${dateStr.slice(0,10)}</span>`;
}

function aheadBadge(fanqie_ch, uploaded_ch) {
  const diff = (fanqie_ch || 0) - (uploaded_ch || 0);
  if (diff <= 0) return `<span class="ahead ok">0</span>`;
  const cls = diff >= 10 ? 'danger' : diff >= 5 ? 'warn' : 'ok';
  return `<span class="ahead ${cls}">+${diff}</span>`;
}

function getWarnTags(book) {
  const tags = [];
  const status = (book.status || '').toLowerCase();
  if (status.includes('Â∑≤ÂÆåÁªì') || status.includes('ho√†n th√†nh')) {
    tags.push('<span class="tag tag-orange">‚úÖ Ho√†n th√†nh</span>');
  }
  if (daysSince(book.last_updated) >= 15) {
    tags.push('<span class="tag tag-red">üïê Stale ' + daysSince(book.last_updated) + 'd</span>');
  }
  const ahead = (book.fanqie_chapters || 0) - (book.uploaded_chapters || 0);
  if (ahead >= 10) {
    tags.push('<span class="tag tag-purple">üìö +' + ahead + ' ch</span>');
  }
  return tags;
}

function isChangedBook(book) {
  return getWarnTags(book).length > 0;
}

function matchChangedFilter(book) {
  if (changedFilter === 'all') return true;
  const status = (book.status || '').toLowerCase();
  if (changedFilter === 'completed') return status.includes('Â∑≤ÂÆåÁªì') || status.includes('ho√†n th√†nh');
  if (changedFilter === 'stale') return daysSince(book.last_updated) >= 15;
  if (changedFilter === 'behind') return ((book.fanqie_chapters || 0) - (book.uploaded_chapters || 0)) >= 10;
  return true;
}

// ============================================================
// RENDER WAITING
// ============================================================
function sortedWaiting() {
  let arr = [...waitingList];
  const s = document.getElementById('waiting-sort')?.value || sortWaiting;
  if (s === 'chapters_asc') arr.sort((a,b) => (a.current_chapters||0)-(b.current_chapters||0));
  if (s === 'chapters_desc') arr.sort((a,b) => (b.current_chapters||0)-(a.current_chapters||0));
  if (s === 'updated_asc') arr.sort((a,b) => (a.last_updated||'').localeCompare(b.last_updated||''));
  if (s === 'updated_desc') arr.sort((a,b) => (b.last_updated||'').localeCompare(a.last_updated||''));
  if (s === 'ready') arr.sort((a,b) => {
    const ra = (a.current_chapters||0) >= (a.desired_chapters||0) ? 0 : 1;
    const rb = (b.current_chapters||0) >= (b.desired_chapters||0) ? 0 : 1;
    return ra - rb;
  });
  return arr;
}

function renderWaiting() {
  const tbody = document.getElementById('waiting-tbody');
  const arr = sortedWaiting();
  let anyReady = false;
  if (!arr.length) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty"><div class="icon">üìã</div>No books in waiting list</div></td></tr>`;
    updateBadges(); return;
  }
  tbody.innerHTML = arr.map(book => {
    const ready = (book.current_chapters || 0) >= (book.desired_chapters || 0);
    if (ready) anyReady = true;
    const readyTag = ready
      ? '<span class="tag tag-green">‚úì READY</span>'
      : `<span class="mono" style="color:var(--text3)">${book.current_chapters||'?'}/${book.desired_chapters}</span>`;
    const chPct = Math.min(100, Math.round(((book.current_chapters||0)/(book.desired_chapters||1))*100));
    const fillCls = chPct >= 100 ? 'progress-fill' : chPct >= 70 ? 'progress-fill warn' : 'progress-fill danger';
    return `<tr class="${selectedWaiting.has(book.fanqie_id) ? 'selected' : ''}" data-id="${book.fanqie_id}">
      <td class="check-col"><input type="checkbox" ${selectedWaiting.has(book.fanqie_id)?'checked':''} onchange="toggleSelect('waiting','${book.fanqie_id}',this.checked)"></td>
      <td class="title-cell">
        <div class="title-main">${book.wiki_id ? `<a href="https://wikicv.net/truyen/${book.wiki_id.replace(/~/g,'%7E')}" target="_blank" class="link" title="${book.vi_title||''}">${book.vi_title||'<em style=color:var(--text3)>Ch∆∞a c√≥ t√™n</em>'}</a>` : (book.vi_title||'<em style=color:var(--text3)>Ch∆∞a c√≥ t√™n</em>')}</div>
        <div class="title-id"><a href="https://fanqienovel.com/page/${book.fanqie_id}" target="_blank" class="link">${book.fanqie_id}</a></div>
      </td>
      <td>
        <div class="progress-wrap">
          <div class="progress-bar"><div class="${fillCls}" style="width:${chPct}%"></div></div>
          <span class="mono">${book.current_chapters||'?'}</span>
        </div>
      </td>
      <td class="mono">${book.desired_chapters}</td>
      <td>${fmtStatus(book.status)}</td>
      <td>${fmtDate(book.last_updated)}</td>
      <td>${readyTag}</td>
    </tr>`;
  }).join('');
  document.getElementById('waiting-ready-banner').style.display = anyReady ? 'flex' : 'none';
  updateSelectionUI();
  updateBadges();
}

// ============================================================
// RENDER UPLOADING
// ============================================================
function sortedUploading() {
  let arr = [...uploadingList];
  const s = document.getElementById('trans-sort')?.value || sortTrans;
  if (s === 'ahead_desc') arr.sort((a,b) => ((b.fanqie_chapters||0)-(b.uploaded_chapters||0)) - ((a.fanqie_chapters||0)-(a.uploaded_chapters||0)));
  if (s === 'ahead_asc') arr.sort((a,b) => ((a.fanqie_chapters||0)-(a.uploaded_chapters||0)) - ((b.fanqie_chapters||0)-(b.uploaded_chapters||0)));
  if (s === 'updated_desc') arr.sort((a,b) => (b.last_updated||'').localeCompare(a.last_updated||''));
  if (s === 'updated_asc') arr.sort((a,b) => (a.last_updated||'').localeCompare(b.last_updated||''));
  return arr;
}

function renderUploading() {
  const tbody = document.getElementById('uploading-tbody');
  const arr = sortedUploading();
  if (!arr.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="icon">‚úçÔ∏è</div>No books in uploading list</div></td></tr>`;
    updateBadges(); return;
  }
  tbody.innerHTML = arr.map(book => {
    const wikiId = book.wiki_id ? book.wiki_id.replace(/~/g, '%7E') : null;
    const wikiLink = wikiId ? `<a href="https://wikicv.net/truyen/${wikiId}" target="_blank" class="link" title="Wiki">W</a>` : '<span style="color:var(--text3)">‚Äî</span>';
    const fanqieLink = `<a href="https://fanqienovel.com/page/${book.fanqie_id}" target="_blank" class="link" title="Fanqie">F</a>`;
    return `<tr class="${selectedUploading.has(book.fanqie_id) ? 'selected' : ''}" data-id="${book.fanqie_id}">
      <td class="check-col"><input type="checkbox" ${selectedUploading.has(book.fanqie_id)?'checked':''} onchange="toggleSelect('uploading','${book.fanqie_id}',this.checked)"></td>
      <td class="title-cell">
        <div class="title-main" title="${book.vi_title||''}">${book.vi_title||'<em style=color:var(--text3)>Ch∆∞a c√≥ t√™n</em>'}</div>
        <div class="title-id">wiki: ${book.wiki_id||'‚Äî'}</div>
      </td>
      <td class="mono">${book.fanqie_chapters||'?'}</td>
      <td class="mono">${book.uploaded_chapters||0}</td>
      <td>${aheadBadge(book.fanqie_chapters, book.uploaded_chapters)}</td>
      <td>${fmtStatus(book.status)}</td>
      <td>${fmtDate(book.last_updated)}</td>
      <td style="white-space:nowrap">${fanqieLink} ${wikiLink}</td>
    </tr>`;
  }).join('');
  updateSelectionUI();
  updateBadges();
}

// ============================================================
// RENDER CHANGED
// ============================================================
function renderChanged() {
  const tbody = document.getElementById('changed-tbody');
  const arr = uploadingList.filter(b => isChangedBook(b) && matchChangedFilter(b));
  if (!arr.length) {
    tbody.innerHTML = `<tr><td colspan="8"><div class="empty"><div class="icon">‚úÖ</div>No alerts</div></td></tr>`;
    updateBadges(); return;
  }
  tbody.innerHTML = arr.map(book => {
    return `<tr class="${selectedChanged.has(book.fanqie_id) ? 'selected' : ''}" data-id="${book.fanqie_id}">
      <td class="check-col"><input type="checkbox" ${selectedChanged.has(book.fanqie_id)?'checked':''} onchange="toggleSelect('changed','${book.fanqie_id}',this.checked)"></td>
      <td class="title-cell">
        <div class="title-main">${book.vi_title||'‚Äî'}</div>
        <div class="title-id">${book.fanqie_id}</div>
      </td>
      <td class="mono">${book.fanqie_chapters||'?'}</td>
      <td class="mono">${book.uploaded_chapters||0}</td>
      <td>${aheadBadge(book.fanqie_chapters, book.uploaded_chapters)}</td>
      <td>${fmtStatus(book.status)}</td>
      <td>${fmtDate(book.last_updated)}</td>
      <td><div class="warn-tags">${getWarnTags(book).join('')}</div></td>
    </tr>`;
  }).join('');
  updateSelectionUI();
  updateBadges();
}

function setChangedFilter(f) {
  changedFilter = f;
  document.querySelectorAll('#changed-filters .pill').forEach(p => {
    p.classList.toggle('active', p.dataset.filter === f);
  });
  renderChanged();
}

function renderAll() {
  renderWaiting();
  renderUploading();
  renderChanged();
  updateBadges();
}

function updateBadges() {
  const readyCount = waitingList.filter(b => (b.current_chapters||0) >= (b.desired_chapters||0)).length;
  document.getElementById('waiting-count-badge').textContent = waitingList.length || '';
  document.getElementById('trans-count-badge').textContent = uploadingList.length || '';
  const changedCount = uploadingList.filter(isChangedBook).length;
  document.getElementById('changed-count-badge').textContent = changedCount || '';
}

// ============================================================
// SELECTION
// ============================================================
function toggleSelect(list, id, checked) {
  const set = list === 'waiting' ? selectedWaiting : list === 'uploading' ? selectedUploading : selectedChanged;
  if (checked) set.add(id); else set.delete(id);
  updateSelectionUI();
  if (list === 'waiting') renderWaiting();
  else if (list === 'uploading') renderUploading();
  else renderChanged();
}

function toggleCheckAll(list, checked) {
  const set = list === 'waiting' ? selectedWaiting : list === 'uploading' ? selectedUploading : selectedChanged;
  const source = list === 'waiting' ? sortedWaiting() : list === 'uploading' ? sortedUploading() : uploadingList.filter(b => isChangedBook(b) && matchChangedFilter(b));
  set.clear();
  if (checked) source.forEach(b => set.add(b.fanqie_id));
  updateSelectionUI();
  if (list === 'waiting') renderWaiting();
  else if (list === 'uploading') renderUploading();
  else renderChanged();
}

function selectAllVisible(list) {
  const set = list === 'waiting' ? selectedWaiting : list === 'uploading' ? selectedUploading : selectedChanged;
  const source = list === 'waiting' ? sortedWaiting() : list === 'uploading' ? sortedUploading() : uploadingList.filter(b => isChangedBook(b) && matchChangedFilter(b));
  source.forEach(b => set.add(b.fanqie_id));
  updateSelectionUI();
  renderAll();
}

function updateSelectionUI() {
  // Waiting
  const wc = selectedWaiting.size;
  document.getElementById('waiting-sel-count').textContent = `${wc} selected`;
  document.getElementById('waiting-sel-count').style.display = wc ? 'inline-flex' : 'none';
  document.getElementById('waiting-del-btn').style.display = wc ? 'inline-flex' : 'none';
  document.getElementById('waiting-promote-btn').style.display = wc ? 'inline-flex' : 'none';
  if (document.getElementById('update-panel').classList.contains('open')) {
    document.getElementById('update-count').textContent = selectedUploading.size;
  }
  // Uploading
  const tc = selectedUploading.size;
  document.getElementById('trans-sel-count').textContent = `${tc} selected`;
  document.getElementById('trans-sel-count').style.display = tc ? 'inline-flex' : 'none';
  document.getElementById('trans-update-btn').style.display = tc ? 'inline-flex' : 'none';
  document.getElementById('trans-del-btn').style.display = tc ? 'inline-flex' : 'none';
  // Changed
  const cc = selectedChanged.size;
  document.getElementById('changed-sel-count').textContent = `${cc} selected`;
  document.getElementById('changed-sel-count').style.display = cc ? 'inline-flex' : 'none';
  document.getElementById('changed-del-btn').style.display = cc ? 'inline-flex' : 'none';
}

// ============================================================
// ADD PANELS
// ============================================================
function toggleAddPanel(list) {
  const el = document.getElementById(`add-panel-${list}`);
  el.classList.toggle('open');
}

async function submitAdd(list) {
  if (!CFG.repo || !CFG.token) { toast('Configure GitHub first.', 'error'); return; }
  const raw = document.getElementById(`${list}-input`).value.trim();
  if (!raw) { toast('Nothing to add.', 'error'); return; }
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);
  let added = 0;
  if (list === 'waiting') {
    for (const line of lines) {
      const parts = line.split('|').map(p => p.trim());
      if (parts.length < 3) { toast(`Invalid line: ${line}`, 'error'); continue; }
      const [vi_title, desired_str, fanqie_id] = parts;
      const desired = parseInt(desired_str);
      if (!fanqie_id || isNaN(desired)) { toast(`Invalid: ${line}`, 'error'); continue; }
      if (waitingList.find(b => b.fanqie_id === fanqie_id)) { toast(`Already in waiting: ${fanqie_id}`, 'error'); continue; }
      waitingList.push({ vi_title, desired_chapters: desired, fanqie_id, current_chapters: null, status: null, last_updated: null });
      added++;
    }
    if (added) { await saveWaiting(); renderWaiting(); document.getElementById('waiting-input').value = ''; toggleAddPanel('waiting'); toast(`Added ${added} book(s).`, 'success'); }
  } else {
    for (const line of lines) {
      const parts = line.split('|').map(p => p.trim());
      if (parts.length < 3) { toast(`Invalid line: ${line}`, 'error'); continue; }
      const [wiki_id, ch_str, fanqie_id] = parts;
      const uploaded = parseInt(ch_str);
      if (!fanqie_id || isNaN(uploaded)) { toast(`Invalid: ${line}`, 'error'); continue; }
      if (uploadingList.find(b => b.fanqie_id === fanqie_id)) { toast(`Already in uploading: ${fanqie_id}`, 'error'); continue; }
      uploadingList.push({ vi_title: null, wiki_id, fanqie_id, uploaded_chapters: uploaded, fanqie_chapters: null, status: null, last_updated: null });
      added++;
    }
    if (added) { await saveUploading(); renderUploading(); document.getElementById('uploading-input').value = ''; toggleAddPanel('uploading'); toast(`Added ${added} book(s).`, 'success'); }
  }
}

// ============================================================
// MOVE TO UPLOADING
// ============================================================
function openMovePanel() {
  if (!selectedWaiting.size) return;
  const books = [...selectedWaiting].map(id => waitingList.find(b => b.fanqie_id === id)).filter(Boolean);
  document.getElementById('move-count').textContent = books.length;
  document.getElementById('move-books-hint').textContent = 'Books: ' + books.map(b => b.vi_title || b.fanqie_id).join(', ');
  document.getElementById('move-wiki-input').value = '';
  document.getElementById('move-panel').classList.add('open');
}

function closeMovePanel() {
  document.getElementById('move-panel').classList.remove('open');
}

async function submitMove() {
  if (!CFG.repo || !CFG.token) { toast('Configure GitHub first.', 'error'); return; }
  const books = [...selectedWaiting].map(id => waitingList.find(b => b.fanqie_id === id)).filter(Boolean);
  const wikiLines = document.getElementById('move-wiki-input').value.split('\n');
  for (let i = 0; i < books.length; i++) {
    const book = books[i];
    const wiki_id = (wikiLines[i] || '').trim() || null;
    if (uploadingList.find(b => b.fanqie_id === book.fanqie_id)) continue;
    uploadingList.push({
      vi_title: book.vi_title,
      wiki_id,
      fanqie_id: book.fanqie_id,
      uploaded_chapters: 0,
      fanqie_chapters: book.current_chapters,
      status: book.status,
      last_updated: book.last_updated
    });
    waitingList = waitingList.filter(b => b.fanqie_id !== book.fanqie_id);
  }
  selectedWaiting.clear();
  await Promise.all([saveWaiting(), saveUploading()]);
  closeMovePanel();
  renderAll();
  toast(`Moved ${books.length} book(s) to Uploading.`, 'success');
}

// ============================================================
// UPDATE CHAPTERS
// ============================================================
function openUpdatePanel() {
  if (!selectedTranslating.size) return;
  document.getElementById('update-count').textContent = selectedTranslating.size;
  // Pre-fill with selected books: fanqieID | current translated ch
  const lines = [...selectedTranslating].map(id => {
    const book = translatingList.find(b => b.fanqie_id === id);
    return `${id} | ${book ? book.translated_chapters || 0 : 0}`;
  }).join('\n');
  document.getElementById('update-chapter-input').value = lines;
  document.getElementById('update-panel').classList.add('open');
}
  function openUpdatePanel() {
  if (!selectedUploading.size) return;
  document.getElementById('update-count').textContent = selectedUploading.size;
  document.getElementById('update-panel').classList.add('open');
}

function closeUpdatePanel() {
  document.getElementById('update-panel').classList.remove('open');
}
async function submitUpdateChapters() {
  if (!CFG.repo || !CFG.token) { toast('Configure GitHub first.', 'error'); return; }
  const lines = document.getElementById('update-chapter-input').value.split('\n').map(l => l.trim()).filter(Boolean);
  let updated = 0;
  for (const line of lines) {
    const [fanqie_id, ch_str] = line.split('|').map(s => s.trim());
    const val = parseInt(ch_str);
    if (!fanqie_id || isNaN(val) || val < 0) { toast(`Invalid line: ${line}`, 'error'); continue; }
    const book = translatingList.find(b => b.fanqie_id === fanqie_id);
    if (book) { book.translated_chapters = val; updated++; }
  }
  await saveTranslating();
  renderTranslating();
  renderChanged();
  toast(`Updated ${updated} book(s).`, 'success');
}

// ============================================================
// DELETE
// ============================================================
function bulkDelete(list) {
  const set = list === 'waiting' ? selectedWaiting : list === 'uploading' ? selectedUploading : selectedChanged;
  if (!set.size) return;
  showModal(
    `Delete ${set.size} book(s)?`,
    `This will permanently remove them from ${list} list.`,
    async () => {
      if (list === 'waiting') {
        waitingList = waitingList.filter(b => !set.has(b.fanqie_id));
        set.clear();
        await saveWaiting();
      } else {
        uploadingList = uploadingList.filter(b => !set.has(b.fanqie_id));
        set.clear();
        await saveUploading();
      }
      renderAll();
      toast('Deleted.', 'success');
    }
  );
}

// ============================================================
// SORT
// ============================================================
function setSortWaiting(col) {
  const sel = document.getElementById('waiting-sort');
  if (col === 'current_chapters') sel.value = sel.value === 'chapters_asc' ? 'chapters_desc' : 'chapters_asc';
  if (col === 'last_updated') sel.value = sel.value === 'updated_asc' ? 'updated_desc' : 'updated_asc';
  renderWaiting();
}

function setSortTrans(col) {
  const sel = document.getElementById('trans-sort');
  if (col === 'ahead') sel.value = sel.value === 'ahead_asc' ? 'ahead_desc' : 'ahead_asc';
  if (col === 'last_updated') sel.value = sel.value === 'updated_asc' ? 'updated_desc' : 'updated_asc';
  renderUploading();
}

// ============================================================
// MODAL
// ============================================================
let _modalCallback = null;
function showModal(title, body, onConfirm) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').textContent = body;
  _modalCallback = onConfirm;
  document.getElementById('confirm-modal').classList.add('open');
}
function closeModal() { document.getElementById('confirm-modal').classList.remove('open'); }
document.getElementById('modal-confirm-btn').onclick = async () => {
  closeModal();
  if (_modalCallback) await _modalCallback();
};

// ============================================================
// TOAST
// ============================================================
let _toastTimer;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + (type || '');
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// ============================================================
// INIT
// ============================================================
loadConfig();
if (CFG.repo && CFG.token) {
  loadData();
} else {
  switchTab('settings');
}
</script>
</body>
</html>
